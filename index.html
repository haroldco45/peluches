<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibras Positivas - Negocio de Marle</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --pink: #ff69b4; --green: #25d366; --bg: #fff5f8; --admin: #5d6d7e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .app-container { max-width: 500px; margin: auto; background: white; border-radius: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid #ffe1ed; }
        .header { background: var(--pink); color: white; padding: 15px; text-align: center; }
        #live-clock { font-size: 0.85em; margin-top: 5px; font-weight: 300; }
        .section { padding: 15px; border-bottom: 1px solid #eee; }
        h3 { margin: 0 0 10px 0; color: var(--pink); font-size: 1.1em; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 8px; width: 100%; box-sizing: border-box; }
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .product-card { background: #fff; border: 1px solid #ffe1ed; border-radius: 15px; padding: 10px; text-align: center; position: relative; }
        .product-card img { width: 100%; height: 120px; object-fit: contain; border-radius: 10px; }
        .product-name { font-size: 0.85em; font-weight: bold; display: block; margin: 8px 0; height: 35px; overflow: hidden; }
        
        .price-display { color: var(--green); font-weight: bold; font-size: 1em; margin-bottom: 5px; display: block; }
        .admin-price-input { display: none; width: 90%; margin: 5px auto; padding: 8px; border: 2px solid var(--pink); border-radius: 8px; text-align: center; font-weight: bold; color: var(--green); }
        .edit-mode .admin-price-input { display: block; }
        .edit-mode .price-display { display: none; }

        .qty-input { width: 70px !important; text-align: center; border: 2px solid #ffe1ed; border-radius: 8px; padding: 5px; font-weight: bold; }
        
        .admin-controls { display: none; background: #eee; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: center; }
        .btn-toggle { position: absolute; top: 5px; right: 5px; background: white; border: 1px solid #ddd; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: none; z-index: 10; }
        .edit-mode .admin-controls { display: block; }
        .edit-mode .btn-toggle { display: flex; align-items: center; justify-content: center; }
        
        .hidden-item { display: none; }
        .edit-mode .hidden-item { display: block; opacity: 0.4; filter: grayscale(1); }

        .resumen-box { background: #fffef0; padding: 10px; border-radius: 10px; border: 1px solid #f1c40f; margin-top: 10px; font-size: 0.9em; }
        .actions { padding: 15px; display: grid; gap: 10px; }
        button { padding: 14px; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-wa { background: var(--green); }
        .btn-xl { background: #1d6f42; }
        .btn-admin-access { background: none; color: #ddd; font-size: 0.7em; padding: 5px; margin-top: 20px; border: none; }
    </style>
</head>
<body id="bodyApp">
<div class="app-container">
    <div class="header">
        <h2 style="margin:0">‚ú® Vibras Positivas ‚ú®</h2>
        <div id="live-clock">Cargando hora de Colombia...</div>
    </div>

    <div class="section">
        <h3>üë§ Tus Datos de Env√≠o</h3>
        <input type="text" id="cNombre" placeholder="Tu Nombre Completo">
        <input type="text" id="cDireccion" placeholder="Direcci√≥n de Env√≠o">
        <input type="tel" id="cCelular" placeholder="Tu Celular">
    </div>

    <div class="section">
        <div class="admin-controls">
            <strong>üîí Panel de Edici√≥n - MARLE</strong><br>
            <p style="font-size:0.7em; margin:5px 0">Cambia precios aqu√≠ o usa el üëÅÔ∏è para ocultar. Para cambios definitivos en todos los usuarios, edita el c√≥digo en GitHub.</p>
        </div>
        <h3>üß∏ Cat√°logo de Peluches</h3>
        <div class="products-grid" id="catalog"></div>
    </div>

    <div class="section">
        <h3>üìù Resumen de Pedido</h3>
        <div id="lista-resumen" class="resumen-box">No has elegido nada a√∫n.</div>
    </div>

    <div class="actions">
        <button class="btn-wa" onclick="enviarWhatsApp()">üü¢ Pedir por WhatsApp</button>
        <button class="btn-xl" onclick="exportarExcel()">üìä Descargar Excel</button>
        <button class="btn-admin-access" onclick="accesoSeguro()">‚öôÔ∏è</button>
    </div>
</div>

<script>
    /**
     * MARLE: Para cambiar el precio base a TODOS, cambia el valor de 'precioPorDefecto'
     */
    const precioPorDefecto = 100000;

    const archivos = [
        "CAPIBARA CERDITO.jpg", "CAPIBARA TIBURON.jpg", "DINOSAURIO AZUL.jpg",
        "POKEMON FUEGO.jpg", "POKEMON PSYDUCK.jpg", "TORO GRIS.jpg",
        "CONEJITOMORADO.JPG", "GATO NEGRO.JPG", "PERRITO.JPG", "UNICORNIO CELESTE.png"
    ];

    // Carga base de datos local para cambios temporales o de ocultar
    let catalogo = JSON.parse(localStorage.getItem('vibras_master_db')) || archivos.map((n, i) => ({
        id: i + 1,
        n: n,
        t: n.split('.')[0],
        p: precioPorDefecto,
        h: false
    }));

    // Sincronizar precio si cambi√≥ en el c√≥digo de GitHub
    catalogo = catalogo.map(item => {
        if (!localStorage.getItem('vibras_master_db')) item.p = precioPorDefecto;
        return item;
    });

    function updateClock() {
        const now = new Date();
        const opt = { timeZone: 'America/Bogota', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' };
        document.getElementById('live-clock').innerHTML = "üá®üá¥ " + now.toLocaleString('es-CO', opt);
    }
    setInterval(updateClock, 1000);

    function mostrar() {
        const c = document.getElementById('catalog');
        c.innerHTML = "";
        catalogo.forEach((item) => {
            const src = `fotos/${item.n}`;
            c.innerHTML += `
                <div class="product-card ${item.h ? 'hidden-item' : ''}">
                    <button class="btn-toggle" onclick="toggleItem(${item.id})">${item.h ? '‚ùå' : 'üëÅÔ∏è'}</button>
                    <img src="${src}" alt="${item.t}" onerror="this.src='https://via.placeholder.com/150?text=Peluche'">
                    <span class="product-name">${item.t}</span>
                    <span class="price-display">$${parseInt(item.p).toLocaleString()}</span>
                    <input type="number" class="admin-price-input" value="${item.p}" onchange="updatePrecio(${item.id}, this.value)">
                    <input type="number" class="qty-input" id="q_${item.id}" data-precio="${item.p}" value="0" min="0" oninput="actualizarResumen()">
                </div>`;
        });
        actualizarResumen();
    }

    function accesoSeguro() {
        const pass = prompt("Contrase√±a de Marle:");
        if(pass === "Marle2026") {
            document.getElementById('bodyApp').classList.toggle('edit-mode');
        } else { alert("Clave incorrecta"); }
    }

    function updatePrecio(id, nuevoPrecio) {
        const index = catalogo.findIndex(x => x.id === id);
        catalogo[index].p = parseInt(nuevoPrecio);
        localStorage.setItem('vibras_master_db', JSON.stringify(catalogo));
        mostrar();
    }

    function toggleItem(id) {
        const index = catalogo.findIndex(x => x.id === id);
        catalogo[index].h = !catalogo[index].h;
        localStorage.setItem('vibras_master_db', JSON.stringify(catalogo));
        mostrar();
    }

    function actualizarResumen() {
        const res = document.getElementById('lista-resumen');
        let html = ""; let total = 0;
        catalogo.forEach(item => {
            const q = document.getElementById(`q_${item.id}`).value;
            if(q > 0 && !item.h) {
                const sub = q * item.p;
                html += `<div>‚Ä¢ ${item.t}: ${q} x $${parseInt(item.p).toLocaleString()} = <b>$${sub.toLocaleString()}</b></div>`;
                total += sub;
            }
        });
        res.innerHTML = html ? html + `<hr><b>TOTAL A PAGAR: $${total.toLocaleString()}</b>` : "No has elegido nada a√∫n.";
    }

    function enviarWhatsApp() {
        const cli = document.getElementById('cNombre').value;
        const dir = document.getElementById('cDireccion').value;
        const time = document.getElementById('live-clock').innerText;
        let txt = `*‚ú® VIBRAS POSITIVAS - NEGOCIO DE MARLE ‚ú®*%0A*Fecha:* ${time}%0A*Cliente:* ${cli}%0A*Direcci√≥n:* ${dir}%0A------------------%0A`;
        let total = 0; let hay = false;
        catalogo.forEach(item => {
            const q = document.getElementById(`q_${item.id}`).value;
            if(q > 0 && !item.h) {
                const sub = q * item.p;
                txt += `‚Ä¢ ${item.t} (x${q}) - $${sub.toLocaleString()}%0A`;
                total += sub; hay = true;
            }
        });
        if(!cli || !hay) return alert("Faltan datos del cliente o productos.");
        txt += `------------------%0A*TOTAL: $${total.toLocaleString()}*`;
        window.open(`https://wa.me/3117700431?text=${txt}`, '_blank');
    }

    function exportarExcel() {
        const cli = document.getElementById('cNombre').value || "Cliente";
        let datos = [
            ["‚ú® VIBRAS POSITIVAS - NEGOCIO DE MARLE ‚ú®"],
            ["Fecha:", document.getElementById('live-clock').innerText],
            ["Cliente:", cli],
            ["Direcci√≥n:", document.getElementById('cDireccion').value],
            [],
            ["Producto", "Cantidad", "Precio Unit.", "Subtotal"]
        ];
        let total = 0;
        catalogo.forEach(item => {
            const q = document.getElementById(`q_${item.id}`).value;
            if(q > 0 && !item.h) {
                const sub = q * item.p;
                datos.push([item.t, q, parseInt(item.p), sub]);
                total += sub;
            }
        });
        datos.push([], ["", "", "TOTAL:", total]);
        const ws = XLSX.utils.aoa_to_sheet(datos);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Factura");
        XLSX.writeFile(wb, `Factura_${cli}.xlsx`);
    }
    window.onload = () => { updateClock(); mostrar(); };
</script>
</body>
</html>
